<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>HOME</title>
	<script src="functions.js"></script>
	<script src="./html5-qrcode/dist/html5-qrcode.min.js"></script>
	<style type="text/css">
		html, body{
			margin: 0;
			height: 100%;
			background-image: url("Images/background-1.jpg");
		}
		body{
			background-repeat: no-repeat;
			background-size: 100% 100%;
		}
		ul{
			display: flex;
			list-style-type: none;
			padding: 0px
		}
		li{
			color: white;
			font-size: 20px;
			margin: 10px;
			width: 150px;
			text-align: center;
			background: linear-gradient(to bottom, #ccff99 -37%, #333300 100%);
		}
		#modal1, #modal2, #searchLoading, #loadingPage{			
		  display: none; /* Hidden by default */
		  position: fixed; /* Stay in place */
		  z-index: 1; /* Sit on top */
		  left: 0;
		  top: 0;
		  width: 100%; /* Full width */
		  height: 100%; /* Full height */
		  overflow: none; /* Enable scroll if needed */
		  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
		}
		#searchLoading{
			background-image: url("Images/background-1.jpg");
			background-repeat: no-repeat;
			background-size: 100% 630px;
		}
		#searchLoading>div{
			width: 50%;
			margin: 240px auto;
			text-align: center;
		}		
		#modal1Content, #modal2Content{
			background: linear-gradient(to bottom, #66ff33 -27%, #009933 100%);
			margin: 15px auto;
			width: 30%;
			height: 95%;
			overflow: auto;
			overflow-x: hidden;
		}
		#modal1Content>p, #modal2Content>p{
			padding: 2px 20px;
			color: white;
			margin: 5px;
		}
		#modal1Content>div>button, #modal2Content>div>button{
			width: 100px;
			height: 30px;
			margin-top: 20px;
		}
		#qrReaderCanDvas{			
		  display: none; /* Hidden by default */
		  position: fixed; /* Stay in place */
		  z-index: 1; /* Sit on top */
		  left: 0;
		  top: 0;
		  width: 100%; /* Full width */
		  height: 100%; /* Full height */
		  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
		}
		#navigationBarDiv{
			display: flex;
			justify-content: space-between;
			padding-top: 0px;
		}
		#navigationBarDiv>ul{
			margin: 0px;
			padding: 0px;
		}
		#navigationBarDiv>button{
			height: 30px;
			width: 120px;
			margin-right: 20px
		}
		#prevNextBtnDiv>button{
			width: 100px;
			height: 40px;
		}
		#displayBooksDiv{
			color: yellow;
			text-align: center;
			/*border:  solid red 1px;*/
		}
		#bookContentDiv{
			display: inline-block;
			width: 250px;
			height: 100%;
			padding: 20px 0px;
			text-align: center;
			margin: 10px 30px;
			/*border:  solid red 1px;*/
		}
		#bookContentDiv>img{
			height: 200px;
			width: 200px;
		}
		#bookContentDiv>table{
			width: 95%;
			margin:  0px auto;
			table-layout: fixed
		}
		#bookContentDiv>table>tbody>tr>td{
			text-align: left;
			height: 35px;
			/*border:  solid red 1px;*/
		}
		#bookContentDiv>table>tbody>tr>td:nth-child(1){
			width: 55px;
			/*border:  solid blue 1px;*/
		}		
		#bookContentDiv>table>tbody>tr>td:nth-child(2){
			width: 5px;
		}		
		#bookContentDiv>table>tbody>tr>td:nth-child(3){
			word-wrap: break-word
		}
		#body{
			width: 100%;
			height: 100%;
		}

		.headerFont{
			color: white;
			font: small-caps bold 40px;
			text-align: center;
		}	


		@media (max-width:  1008px){
			#bookContentDiv{
				margin: 10px 25px;
			}
		}


		@media (max-width:  965px){
			#bookContentDiv{
				margin: 10px 15px;
			}
		}


		@media (max-width:  901px){
			#bookContentDiv{
				margin: 10px 60px;
			}
		}


		@media (max-width:  840px){
			#navigationBarDiv{
				flex-direction: column;
			}
			#navigationBarDiv>button{
				display: block;
				width: 40%;
				font-size: 12px;
				margin: 20px auto !important;
			}

		}


		@media (max-width:  830px){
			#bookContentDiv{
				margin: 10px 35px;
			}
		}


		@media (max-width: 700px){
			#mainContentDiv>div{				
				flex-direction: column;
			}
			#bookContentDiv{
				margin: 10px 30px;
			}
			#prevNextBtnDiv{
				flex-direction: row !important
			}
			#modal1Content, #modal2Content{
				background-color: white;
				margin: 3% auto;
				width: 80%;
				height: 94%;
				overflow: auto;
				overflow-x: hidden;
				padding: 10px;
			}
			#qrReader{
				max-height: 200px;
			}
			#qrReaderCanvas{
				max-height: 200px;
			}
			li{
				font-size: 14px;
				margin: 6px;
			}
		}


		@media (max-width:  680px){
			#bookContentDiv{
				margin: 10px 20px;
			}
		}


		@media (max-width:  627px){
			#bookContentDiv{
				margin: 10px 15px;
			}
		}



	</style>
</head>
<body onload="bodyLoad()">
	<div id="loadingPage" style="display: block; z-index: 3">
		<!-- <img src="https://i.gifer.com/7Fmb.gif" style="opacity: 1; width: 100px; height: 100px; border-radius: 50%;"> -->
		<img src="Images/loadingPage.gif" style="width: 100%; height: 100%; border-radius: 0px;">
	</div>
	<div id="searchLoading">
		<div>
			<!-- <img src="https://i.gifer.com/7Fmb.gif" style="opacity: 1; width: 100px; height: 100px; border-radius: 50%;"> -->
			<img src="https://thumbs.gfycat.com/IndolentDistantBuffalo-max-1mb.gif" style="opacity: 1; width: 100px; height: 100px; border-radius: 50%;">
		</div>
	</div>
	<div style="width: 100%; height: 100%; display: none;" id="qrReader">
		<div id="reader" width="100%"></div>
		<button onclick="qrReaderCancelBtnFunc()">Cancel</button>
	</div>

	<div id="body">
		<p id="greetings" style="color: white; font-size: 20px">Hello</p>
		<h1 class="headerFont">SS19 LIBRARY</h1>
		<div id="navigationBarDiv">
			<ul>
				<li onclick="window.location.href = 'userHomepage.html'">Homepage</li>
				<li onclick="window.location.href = 'userBooks.html'">Books</li>
				<li onclick="window.location.href = 'userProfile.html'">Profile</li>
				<li onclick="window.location.href = 'userHowToUse.html'">How To Use</li>
			</ul>
			<button onclick="scanQRBtnFunc()">Scan QR Code</button>
		</div>
		<div id="mainContentDiv">
			<div id="displayBooksDiv" style="width: 95%; margin: 10px auto">
				
			</div>
			<div id="prevNextBtnDiv" style="display: flex; width: 100%; justify-content: center; margin-top: 20px">
				<button onclick="prevBtnFunc()" id="prevBtn">Prev</button>
				<span style="width: 20px"></span>
				<button onclick="nextBtnFunc()" id="nextBtn">Next</button>
			</div>
		</div>


		<div id="modal1">
			<div id="modal1Content">
				<img src="" id="modal1Image" style="width: 200px; height: 250px; margin: 20px auto; display: block;">
				<p id="modal1Title"></p>
				<p id="modal1Author"></p>
				<p id="modal1Category"></p>
				<p id="modal1Genre"></p>
				<p id="modal1DateBorrowed"></p>
				<p id="modal1DateExpectedReturn"></p>
				<p id="modal1RemainingOverdue"></p>
				<div style="display: flex; width: 90%; margin: 10px auto; justify-content: space-around;">
					<button onclick="closeModals()">Cancel</button>
					<button onclick="returnBookFunc()">Returned</button>
				</div>
			</div>		
		</div>
		<div id="modal2">
			<div id="modal2Content">
				<img src="" id="modal2Image" style="width: 200px; height: 250px; margin: 20px auto; display: block;">
				<p id="modal2Title"></p>
				<p id="modal2Author"></p>
				<p id="modal2Category"></p>
				<p id="modal2Genre"></p>
				<div style="display: flex; width: 90%; margin: 10px auto; justify-content: space-around;">
					<button onclick="closeModals()">Cancel</button>
					<button onclick="bookNowBtnFunc()">Book Now!</button>
				</div>
			</div>		
		</div>
	</div>

<script type="text/javascript">	

	var databaseLink = "https://libraryss19.herokuapp.com"
	// var databaseLink = "http://libraryss19.test"
	var userData = JSON.parse(sessionStorage.getItem('userData'))
	console.log(userData)
	if(userData == null){
		window.location.href = "logintest.html";
	}
	var userId = userData.id
	console.log(userId);
	document.getElementById('greetings').innerHTML = "Hello "+userData.name
	var currentPage = 1
	var lastPage = 0
	var bookData = null
	
	var cameraId = ""


	function bodyLoad(){
		console.log("body loaded")
		setTimeout(function(){
			document.getElementById("loadingPage").style.display = "none"
		}, 1000)		
	}

	



	function onScanSuccess(decodedText, decodedResult) {
	  // handle the scanned code as you like, for example:
	  console.log(`Code matched = ${decodedText}`, decodedResult);
	  // alert(decodedText)
	  	fetch(decodedText, {
			method: 'GET', // or 'PUT'
			headers: {
				'Content-Type': 'application/json',
			}
		})
		.then(response => response.json())
		.then(data => {
			console.log('Success:', data);
			bookData = data[1][0]
			console.log(bookData)
			if(bookData.image == null){
				document.getElementById('modal2Image').setAttribute('src', 'https://thumbs.dreamstime.com/b/no-image-available-icon-vector-illustration-flat-design-140476186.jpg')
			}else{
				document.getElementById('modal2Image').setAttribute('src', databaseLink+'/api/get-cover-page/'+bookData.image.split('/')[1])
			}
			document.getElementById('modal2Title').innerHTML = "Title : "+bookData.name
			document.getElementById('modal2Author').innerHTML = "Author : "+bookData.author
			document.getElementById('modal2Category').innerHTML = "Category : "+bookData.category
			document.getElementById('modal2Genre').innerHTML = "Genre : "+bookData.genre

			document.getElementById('body').style.display = "block"
			document.getElementById('qrReader').style.display = "none"
	  		modal2Visibility()

		})
		.catch((error) => {
			console.error('Error:', error);
			alert("Invalid QR Code. Try Again.")
		});

	}

	function onScanFailure(error) {
	  // handle scan failure, usually better to ignore and keep scanning.
	  // for example:
	  console.warn(`Code scan error = ${error}`);
	}

	let html5QrcodeScanner = new Html5QrcodeScanner(
	  "reader",
	  { fps: 10, qrbox: {width: 250, height: 250} },
	  /* verbose= */ false);
	html5QrcodeScanner.render(onScanSuccess, onScanFailure);







	function scanQRBtnFunc(){
		document.getElementById('body').style.display = "none"
		document.getElementById('qrReader').style.display = "block"
	}

	function qrReaderCancelBtnFunc(){
		document.getElementById('body').style.display = "block"
		document.getElementById('qrReader').style.display = "none"
	}

	
	function bookNowBtnFunc(){
		console.log(bookData)
		console.log(bookData.id)
		const data = {
			member_id: userId,
			book_id: bookData.id,
			status: "active"
		};
		fetch(databaseLink+'/api/new-book-borrowed', {
			method: 'PUT', // or 'PUT'
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify(data),
		})
		.then(response => response.json())
		.then(data => {
			console.log('Success:', data);
			loadBooksFunc()
		})
		.catch((error) => {
			console.error('Error:', error);
		});
	}
	

	function returnBookFunc(){
		fetch(databaseLink+'/api/return-book-borrowed/'+bookData.id, {
			method: 'PUT', // or 'PUT'
			headers: {
				'Content-Type': 'application/json',
			}
		})
		.then(response => response.json())
		.then(data => {
			console.log('Success:', data);
			loadBooksFunc()
			closeModals()
		})
		.catch((error) => {
			console.error('Error:', error);
		});
	}



	function loadBooksFunc(){
		var displayBooksDiv = document.getElementById('displayBooksDiv')
		displayBooksDiv.innerHTML = ""
		console.log(displayBooksDiv)
		
		fetch(databaseLink+'/api/books-borrowed/'+userId+'?page='+currentPage, {
			method: 'GET', // or 'PUT'
			headers: {
				'Content-Type': 'application/json',
			}
		})
		.then(response => response.json())
		.then(data => {
			console.log('Success:', data);
			closeModals()
			lastPage = data[1].last_page

			if(currentPage == lastPage){
				document.getElementById('nextBtn').disabled = true
				document.getElementById('prevBtn').disabled = true
				if(lastPage > 1){
					document.getElementById('prevBtn').disabled = false
				}
			}else{
				document.getElementById('nextBtn').disabled = false
				document.getElementById('prevBtn').disabled = false
				if(currentPage == 1){
					document.getElementById('prevBtn').disabled = true
				}
			}

			var data = data[1].data
			if(data == ""){
				console.log("empty")
				displayBooksDiv.innerHTML = "NO BOOKS BORROWED"
				return;
			}else{
			}
			var dataLength = data.length
			for(var i=0; i<dataLength; i++){
				var bookContentDiv = document.createElement('DIV')
				console.log(bookContentDiv)
				bookContentDiv.setAttribute('id', 'bookContentDiv')
				console.log(data[i].book_id.availability)
				if(data[i].status == "late"){
					bookContentDiv.setAttribute('style', 'background-color: red')
				}else if(data[i].status == "active"){
					bookContentDiv.setAttribute('style', 'background-color: green')
				}					

				var image = document.createElement('IMG')
				console.log(data[i].book_id.image)
				if(data[i].book_id.image == null){
					image.setAttribute('src', 'https://thumbs.dreamstime.com/b/no-image-available-icon-vector-illustration-flat-design-140476186.jpg')
				}else{
					console.log(databaseLink+'/api/get-cover-page/'+data[i].book_id.image.split('/')[1])
					image.setAttribute('src', databaseLink+'/api/get-cover-page/'+data[i].book_id.image.split('/')[1])
				}

				var table = document.createElement('table')
				var tr1 = table.insertRow()
				var td1a = tr1.insertCell()
				var td1b = tr1.insertCell()
				var td1c = tr1.insertCell()
				td1a.appendChild(document.createTextNode('Title'))
				td1b.appendChild(document.createTextNode(':'))
				td1c.appendChild(document.createTextNode(data[i].book_id.name))

				var tr2 = table.insertRow()
				var td2a = tr2.insertCell()
				var td2b = tr2.insertCell()
				var td2c = tr2.insertCell()
				td2a.appendChild(document.createTextNode('Genre'))
				td2b.appendChild(document.createTextNode(':'))
				td2c.appendChild(document.createTextNode(data[i].book_id.genre))

				var tr3 = table.insertRow()
				var td3a = tr3.insertCell()
				var td3b = tr3.insertCell()
				var td3c = tr3.insertCell()
				td3a.appendChild(document.createTextNode('Author'))
				td3b.appendChild(document.createTextNode(':'))
				td3c.appendChild(document.createTextNode(data[i].book_id.author))

				var tr4 = table.insertRow()
				var td4a = tr4.insertCell()
				var td4b = tr4.insertCell()
				var td4c = tr4.insertCell()
				td4a.appendChild(document.createTextNode('Category'))
				td4b.appendChild(document.createTextNode(':'))
				td4c.appendChild(document.createTextNode(data[i].book_id.category))

				var para = document.createElement('P')
				para.setAttribute('id', 'bookBorrowedId')
				para.setAttribute('style', 'display: none')
				para.innerHTML = data[i].id

				bookContentDiv.appendChild(image)
				bookContentDiv.appendChild(table)
				bookContentDiv.appendChild(para)
				
				displayBooksDiv.appendChild(bookContentDiv)
				
				bookContentDiv.addEventListener('click', function(e){
					console.log('clciked')
					console.log(this.children[2].textContent)

					modal1Visibility()
					var bookBorrowedId = this.children[2].textContent

					fetch(databaseLink+'/api/book-borrowed/'+bookBorrowedId, {
						method: 'GET', // or 'PUT'
						headers: {
							'Content-Type': 'application/json',
						}
					})
					.then(response => response.json())
					.then(data => {
						console.log('Success:', data);
						data = data[1][0]
						bookData = data.book_id
						if(data.book_id.image == null){
							document.getElementById('modal1Image').setAttribute('src', 'https://thumbs.dreamstime.com/b/no-image-available-icon-vector-illustration-flat-design-140476186.jpg')
						}else{
							console.log(databaseLink+'/api/get-image/'+data.book_id.image.split('/')[1])
							document.getElementById('modal1Image').setAttribute('src', databaseLink+'/api/get-cover-page/'+data.book_id.image.split('/')[1])
						}
						document.getElementById('modal1Title').innerHTML = "Title : "+data.book_id.name
						document.getElementById('modal1Author').innerHTML = "Author : "+data.book_id.author
						document.getElementById('modal1Category').innerHTML = "Category : "+data.book_id.category
						document.getElementById('modal1Genre').innerHTML = "Genre : "+data.book_id.genre
						var borrowDate = getProperDate(new Date(data.created_at))
						document.getElementById('modal1DateBorrowed').innerHTML = "Date Borrowed : "+borrowDate
						var expReturnDate = getProperDate(addDaysToDate(new Date(data.created_at), 7))
						document.getElementById('modal1DateExpectedReturn').innerHTML = "Expected Return Date : "+expReturnDate
						var todayDate = new Date()
						var remainingOverdueDate = Math.ceil(differenceInDates(expReturnDate, todayDate))
						document.getElementById('modal1RemainingOverdue').innerHTML = "Days Remaining : "+remainingOverdueDate

						if(data.status == "late"){
							document.getElementById("modal1Content").setAttribute("style", "background: linear-gradient(to bottom, #ff5050 -27%, #ff0000 100%)")
						}else{
							document.getElementById("modal1Content").setAttribute("style", "background: linear-gradient(to bottom, #66ff33 -27%, #009933 100%)")
						}

					})
					.catch((error) => {
						console.error('Error:', error);
					});
				})
			}			
		})
		.catch((error) => {
			console.error('Error:', error);
		});
	}loadBooksFunc()
	

	function nextBtnFunc(){
		currentPage = currentPage + 1
		console.log(currentPage)	
		loadBooksFunc()
	}


	function prevBtnFunc(){
		currentPage = currentPage - 1
		loadBooksFunc()
	}


	function modal1Visibility(){
		console.log("modal 1 clicked")
		modal1.style.display = "block"
		modal2.style.display = "none"
	}

	function modal2Visibility(){
		console.log("modal 2 clicked")
		modal1.style.display = "none"
		modal2.style.display = "block"
	}

	function closeModals(){
		console.log("close modals clicked")
		modal1.style.display = "none"
		modal2.style.display = "none"
	}
	// const data = { username: 'example' };
	// fetch('https://example.com/profile', {
	// 	method: 'POST', // or 'PUT'
	// 	headers: {
	// 		'Content-Type': 'application/json',
	// 	},
	// 	body: JSON.stringify(data),
	// })
	// .then(response => response.json())
	// .then(data => {
	// 	console.log('Success:', data);
	// })
	// .catch((error) => {
	// 	console.error('Error:', error);
	// });

</script>

</body>
</html>