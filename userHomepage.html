<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>HOME</title>
	<script src="functions.js"></script>
	<script src="node_modules\jsqr\dist\jsQR.js"></script>
	<style type="text/css">
		ul{
			display: flex;
			list-style-type: none;
			padding: 0px
		}
		li{
			margin: 10px;
			width: 100px
		}
		#modal{			
		  display: none; /* Hidden by default */
		  position: fixed; /* Stay in place */
		  z-index: 1; /* Sit on top */
		  left: 0;
		  top: 0;
		  width: 100%; /* Full width */
		  height: 100%; /* Full height */
		  overflow: none; /* Enable scroll if needed */
		  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
		}
		#modalContent{
			background-color: white;
			margin: 3% auto;
			width: 30%;
			height: 90%;
			overflow: auto;
			overflow-x: hidden;
		}
		#modalContent>p{
			margin: 5px;
		}
		#modalContent>div>button{
			width: 100px;
			height: 30px;
			margin-top: 20px;
		}
		#qrReaderCanDvas{			
		  display: none; /* Hidden by default */
		  position: fixed; /* Stay in place */
		  z-index: 1; /* Sit on top */
		  left: 0;
		  top: 0;
		  width: 100%; /* Full width */
		  height: 100%; /* Full height */
		  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
		}
		@media (max-width: 700px){
			#navigationBarDiv{
				flex-direction: column;
			}
			#navigationBarDiv>button{
				display: block;
				width: 300px;
				margin: 0px auto !important;
			}
			#navigationBarDiv>ul{
				width: 90%;
				margin: 20px auto;
				justify-content: space-around;
			}
			#navigationBarDiv>ul>li{
				text-align: center;
			}
			#mainContentDiv>div{				
				flex-direction: column;
			}
			#displayBooksDiv>div{
				flex-direction: column;
				width: 95%;
				margin: 10px auto;
				background-color: black;
				padding: 0px
			}
			#bookContentDiv{
				width: 70% !important;
				margin: 10px auto;
				border: solid yellow 5px;
			}
			#prevNextBtnDiv{
				flex-direction: row !important
			}
			#modalContent{
				background-color: white;
				margin: 3% auto;
				width: 80%;
				height: 94%;
				overflow: auto;
				overflow-x: hidden;
				padding: 10px;
			}
		}
	</style>
</head>
<body>	
	<video id="qrReader" style="border: red solid 1px; display: block;"></video>
	<canvas id="qrReaderCanvas" style="border: solid red 1px; display: block;"></canvas>
	<!-- <canvas id="secondCanvas" style="border: solid red 1px;"></canvas> -->
	<div style="display: flex; justify-content: space-between; margin: 0px 10px">
		<p>Hello Name</p>
		<img style="height: 20px" src="cart.png" onclick="checkOutCartFunc()">
	</div>
	<h1 style="width: 100%; text-align: center">SS 19 MINI LIBRARY</h1>
	<div id="navigationBarDiv" style="display: flex; justify-content: space-between">
		<ul>
			<li onclick="window.location.href = 'userHomepage.html'">Homepage</li>
			<li onclick="window.location.href = 'userBooks.html'">Books</li>
			<li onclick="window.location.href = 'userProfile.html'">Profile</li>
			<li onclick="window.location.href = 'userHowToUse.html'">How To Use</li>
		</ul>
		<button style="height: 30px; margin-top: 20px; margin-right: 20px" onclick="scanQRBtnFunc()">Scan QR Code</button>
		<button onclick="pause()">pause</button>
	</div>
	<div id="mainContentDiv">
		<div id="displayBooksDiv" style="width: 90%; margin: 10px auto">
			
		</div>
		<div id="prevNextBtnDiv" style="display: flex; width: 100%; justify-content: center; margin-top: 20px">
			<button onclick="prevBtnFunc()" id="prevBtn">Prev</button>
			<span style="width: 20px"></span>
			<button onclick="nextBtnFunc()" id="nextBtn">Next</button>
		</div>
	</div>
	<div id="modal">
		<div id="modalContent">
			<img src="" id="modalImage" style="width: 200px; margin: 20px auto; display: block;">
			<p id="modalTitle"></p>
			<p id="modalAuthor"></p>
			<p id="modalCategory"></p>
			<p id="modalGenre"></p>
			<p id="modalDateBorrowed"></p>
			<p id="modalDateExpectedReturn"></p>
			<p id="modalRemainingOverdue"></p>
			<div style="display: flex; width: 90%; margin: 10px auto; justify-content: space-around;">
				<button onclick="modalVisibility()">Cancel</button>
				<button>Returned</button>
			</div>
		</div>		
	</div>

<script type="text/javascript">	

	var databaseLink = "https://libraryss19.herokuapp.com"
	var currentPage = 1
	var lastPage = 0
	
	var cameraId = ""


	function checkOutCartFunc(){
		console.log("check out button clicked")
	}

	function pause(){
		var qrReader = document.getElementById('qrReader')
		qrReader.pause()
		if(qrReader.pause){
			console.log("paused")
		}
	}
	

	function scanQRBtnFunc(){
		document.getElementById('qrReaderCanvas').style.display = "block"

		var qrReader = document.getElementById('qrReader')
		if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
			navigator.mediaDevices.getUserMedia({
				video: {
					facingMode: 'environment'
			}
		}).then((stream)=> {
				qrReader.srcObject = stream
				qrReader.play()
			})
		}
		
		qrReaderCanvasFunc()
	}
	function qrReaderCanvasFunc(){
		var qrReaderCanvas = document.getElementById('qrReaderCanvas')
		var ctx = qrReaderCanvas.getContext('2d')
		var qrReader = document.getElementById('qrReader')
		console.log(qrReader.videoHeight)
		console.log(qrReader.videoWidth)
		if(qrReader.play()){
			qrReaderCanvas.width = qrReader.videoWidth
			qrReaderCanvas.height = qrReader.videoHeight

			ctx.drawImage(qrReader, 0, 0)

			ctx.beginPath();
			ctx.lineWidth = "4";
			ctx.strokeStyle = "blue";
			ctx.rect(120, 40, 400, 400);
			ctx.stroke();

			var imageData = ctx.getImageData(120, 42, 400, 400)
			console.log(imageData.data)
			const code = jsQR(imageData.data, 400, 400);

			if (code) {
			  alert("Found QR code", code);
			}
		}

		// var canvastwo = document.getElementById('secondCanvas')
		// canvastwo.width = qrReader.videoWidth
		// 	canvastwo.height = qrReader.videoHeight
		// var ctx2 = canvastwo.getContext('2d')
		// ctx2.putImageData(imageData, 0, 0)
		
		// setTimeout(qrReaderCanvasFunc, 10);
	}

	
	
	


	function loadBooksFunc(){
		var displayBooksDiv = document.getElementById('displayBooksDiv')
		displayBooksDiv.innerHTML = ""
		console.log(displayBooksDiv)
		
		fetch(databaseLink+'/api/books-borrowed/1?page='+currentPage, {
			method: 'GET', // or 'PUT'
			headers: {
				'Content-Type': 'application/json',
			}
		})
		.then(response => response.json())
		.then(data => {
			console.log('Success:', data);
			lastPage = data[1].last_page

			if(currentPage == lastPage){
				document.getElementById('nextBtn').style.display = "none"
				document.getElementById('prevBtn').style.display = "none"
				if(lastPage > 1){
					document.getElementById('prevBtn').style.display = "block"
				}
			}else{
				document.getElementById('nextBtn').style.display = "block"
				document.getElementById('prevBtn').style.display = "block"
				if(currentPage == 1){
					document.getElementById('prevBtn').style.display = "none"
				}
			}

			var data = data[1].data
			var dataLength = data.length
			var dataNumber = 0
			for(var i=0; i<dataLength/3; i++){
				var div = document.createElement('DIV')
				div.setAttribute("style", "display: flex; justify-content: space-around")
				displayBooksDiv.appendChild(div)
				for (var j=0; j<3; j++){
					var bookContentDiv = document.createElement('DIV')
					console.log(bookContentDiv)
					bookContentDiv.setAttribute('id', 'bookContentDiv')
					console.log(data[dataNumber].book_id.availability)
					if(data[dataNumber].status == "late"){
						bookContentDiv.setAttribute('style', 'width: 30%; padding: 10px; text-align: center; background-color: red; margin-top: 10px')
					}else if(data[dataNumber].status == "active"){
						bookContentDiv.setAttribute('style', 'width: 30%; padding: 10px; text-align: center; background-color: green; margin-top: 10px')
					}					

					var image = document.createElement('IMG')
					image.setAttribute('src', 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRTY_6xlv6z30igW5fW7--EW0owZJWX0aedcQ&usqp=CAU')
					image.setAttribute('style', 'height: 200px')
					var paraDiv = document.createElement('DIV')
					paraDiv.setAttribute('style', 'text-align:left; width: 60%; margin: 0px auto')
					paraDiv.innerHTML = "Title : "+data[dataNumber].book_id.name+"<br>"+"Author : "+data[dataNumber].book_id.author+"<br>"+"Category : "+data[dataNumber].book_id.category+"<br>"+"Genre : "+data[dataNumber].book_id.genre

					var para = document.createElement('P')
					para.setAttribute('id', 'bookBorrowedId')
					para.setAttribute('style', 'display: none')
					para.innerHTML = data[dataNumber].id

					bookContentDiv.appendChild(image)
					bookContentDiv.appendChild(paraDiv)
					bookContentDiv.appendChild(para)
					
					div.appendChild(bookContentDiv)
					
					bookContentDiv.addEventListener('click', function(e){
						console.log('clciked')
						console.log(this.children[2].textContent)

						modalVisibility()
						var bookBorrowedId = this.children[2].textContent

						fetch(databaseLink+'/api/book-borrowed/'+bookBorrowedId, {
							method: 'GET', // or 'PUT'
							headers: {
								'Content-Type': 'application/json',
							}
						})
						.then(response => response.json())
						.then(data => {
							console.log('Success:', data);
							data = data[1][0]
							document.getElementById('modalImage').setAttribute('src', 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRTY_6xlv6z30igW5fW7--EW0owZJWX0aedcQ&usqp=CAU')
							document.getElementById('modalTitle').innerHTML = "Title : "+data.book_id.name
							document.getElementById('modalAuthor').innerHTML = "Author : "+data.book_id.author
							document.getElementById('modalCategory').innerHTML = "Category : "+data.book_id.category
							document.getElementById('modalGenre').innerHTML = "Genre : "+data.book_id.genre
							var borrowDate = getProperDate(new Date(data.created_at))
							document.getElementById('modalDateBorrowed').innerHTML = "Date Borrowed : "+borrowDate
							var expReturnDate = getProperDate(addDaysToDate(new Date(data.created_at), 7))
							document.getElementById('modalDateExpectedReturn').innerHTML = "Expected Return Date : "+expReturnDate
							var todayDate = new Date()
							var remainingOverdueDate = Math.ceil(differenceInDates(expReturnDate, todayDate))
							document.getElementById('modalRemainingOverdue').innerHTML = "Days Remaining : "+remainingOverdueDate

						})
						.catch((error) => {
							console.error('Error:', error);
						});
					})

					dataNumber = dataNumber + 1
					if(dataNumber == dataLength){
						return;
					}
				}
			}			
		})
		.catch((error) => {
			console.error('Error:', error);
		});
	}loadBooksFunc()
	

	function nextBtnFunc(){
		currentPage = currentPage + 1
		console.log(currentPage)	
		loadBooksFunc()
	}


	function prevBtnFunc(){
		currentPage = currentPage - 1
		loadBooksFunc()
	}


	function modalVisibility(){
		var modalDisplay = document.getElementById('modal').style.display
		console.log(modalDisplay)
		if(modalDisplay == "block"){
			document.getElementById('modal').style.display = "none"
		}else{
			document.getElementById('modal').style.display = "block"
		}
	}
	// const data = { username: 'example' };
	// fetch('https://example.com/profile', {
	// 	method: 'POST', // or 'PUT'
	// 	headers: {
	// 		'Content-Type': 'application/json',
	// 	},
	// 	body: JSON.stringify(data),
	// })
	// .then(response => response.json())
	// .then(data => {
	// 	console.log('Success:', data);
	// })
	// .catch((error) => {
	// 	console.error('Error:', error);
	// });

</script>

</body>
</html>